<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Natural Power</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../../../static/css/style.css">
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand text-success" href="/app/inicio/"><i class="bi bi-tree-fill me-2"></i><strong>Natural Power</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/app/inicio/">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/app/catalogo/">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="/app/crea-tu-jugo/">Crea tu Jugo</a></li>
                </ul>
                
                <form class="d-flex mx-lg-2" onsubmit="event.preventDefault(); searchProducts();">
                    <input id="search-input" class="form-control me-2" type="search" placeholder="Buscar jugos..." onkeyup="searchProducts()">
                </form>

                <div class="d-flex align-items-center">
                    <div id="guest-actions" class="d-flex">
                        <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Registrarse</button>
                    </div>
                    <div id="user-actions" class="d-flex align-items-center" style="display: none;">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-person-circle me-1"></i> <span id="user-dropdown-name"></span></a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/app/cuenta/">Mi Cuenta</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" onclick="logout()">Cerrar Sesión</button></li>
                            </ul>
                        </div>
                    </div>
                    <a href="/app/carrito/" class="btn btn-link text-dark ms-2 position-relative fs-5"><i class="bi bi-cart"></i><span id="cart-counter" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="font-size: 0.6rem;"></span></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container my-5 pt-5">
        <h2 class="section-title">Pago y Envío</h2>
        <div class="row">
            <div class="col-md-7">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>Dirección de Envío</h5>
                        <form id="shipping-form">
                            <div class="mb-3"><label class="form-label">Dirección</label><input type="text" class="form-control" id="ship-address" required></div>
                            <div class="mb-3"><label class="form-label">Comuna</label><input type="text" class="form-control" id="ship-city" required></div>
                            <div class="mb-3"><label class="form-label">Teléfono</label><input type="text" class="form-control" id="ship-phone" required></div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5>Método de Pago</h5>
                        <select id="payment-method" class="form-select mb-3"><option value="card">Tarjeta</option><option value="cash">Efectivo</option></select>
                        <div id="payment-details"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card">
                    <div class="card-body">
                        <h5>Resumen</h5>
                        <div id="checkout-summary"></div>
                        <div class="d-grid mt-3"><button id="checkout-cta" class="btn btn-success btn-lg" onclick="payWithMercadoPago()">Pagar con MercadoPago</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../../static/js/config.js"></script>
    <script src="../../../static/js/main.js"></script>
    <script src="../../../static/js/auth.js"></script>
    <script src="../../../static/js/cart.js"></script>
    
    <!-- Protección de autenticación -->
    <script>
        if (!requireAuth()) {
            document.body.innerHTML = '<div class="container mt-5 pt-5 text-center"><h3>Redirigiendo...</h3><p>Debes iniciar sesión para realizar el pago</p></div>';
        } else {
            loadCheckoutPage();
        }

        let cartItems = [];

        async function loadCheckoutPage() {
            let serverItems = [];
            try { serverItems = await Cart.getItems(); } catch(_) { serverItems = []; }

            if (!serverItems || serverItems.length === 0) {
                let fallbackItems = [];
                try { fallbackItems = getCart(); } catch(_) { fallbackItems = []; }
                if (fallbackItems.length > 0 && typeof Cart.ensureServerCart === 'function') {
                    const synced = await Cart.ensureServerCart(fallbackItems);
                    if (synced && synced.length > 0) {
                        serverItems = synced;
                    } else {
                        cartItems = fallbackItems;
                    }
                } else {
                    cartItems = fallbackItems;
                }
            }

            if (!cartItems || cartItems.length === 0) {
                cartItems = serverItems && serverItems.length > 0 ? serverItems : (cartItems || []);
            }

            if (!cartItems || cartItems.length === 0) {
                document.querySelector('main').innerHTML = `
                    <div class="container my-5 pt-5 text-center">
                        <h3>Tu carrito está vacío</h3>
                        <p class="text-muted">Agrega productos desde el catálogo</p>
                        <a href="/app/catalogo/" class="btn btn-primary mt-3">Ver Catálogo</a>
                    </div>
                `;
                return;
            }

            renderCheckoutSummary();
            setupPaymentMethodChange();
        }

        function renderCheckoutSummary() {
            const summaryDiv = document.getElementById('checkout-summary');
            const total = Cart.calculateTotal(cartItems);

            let itemsHtml = cartItems.map(item => `
                <div class="d-flex justify-content-between mb-2">
                    <span>${item.name} x${item.quantity}</span>
                    <span>$${(item.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('');

            summaryHtml = `
                ${itemsHtml}
                <hr>
                <div class="d-flex justify-content-between fs-5">
                    <strong>Total</strong>
                    <strong>$${total.toLocaleString()}</strong>
                </div>
            `;

            summaryDiv.innerHTML = summaryHtml;
        }

        function setupPaymentMethodChange() {
            const paymentMethod = document.getElementById('payment-method');
            const paymentDetails = document.getElementById('payment-details');
            const cta = document.getElementById('checkout-cta');

            paymentMethod.addEventListener('change', function() {
                if (this.value === 'card') {
                    paymentDetails.innerHTML = `
                        <div class="mb-3">
                            <label class="form-label">Número de Tarjeta</label>
                            <input type="text" class="form-control" id="card-number" placeholder="1234 5678 9012 3456" required>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Fecha de Vencimiento</label>
                                <input type="text" class="form-control" id="card-expiry" placeholder="MM/AA" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" id="card-cvv" placeholder="123" required>
                            </div>
                        </div>
                    `;
                    if (cta){ cta.textContent = 'Pagar ahora'; cta.onclick = payWithCard; }
                } else if (this.value === 'cash') {
                    paymentDetails.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Pagarás en efectivo al recibir tu pedido.
                        </div>
                    `;
                    if (cta){ cta.textContent = 'Confirmar pedido'; cta.onclick = placeCashOrder; }
                }
            });

            // Trigger inicial
            paymentMethod.dispatchEvent(new Event('change'));
        }

        async function ensureCheckoutCart(){
            try {
                let serverItems = await Cart.getItems();
                if (!serverItems || serverItems.length === 0) {
                    if (cartItems && cartItems.length && typeof Cart.ensureServerCart === 'function') {
                        serverItems = await Cart.ensureServerCart(cartItems);
                    }
                }
                if (serverItems && serverItems.length) {
                    cartItems = serverItems;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('No se pudo verificar el carrito en el servidor', error);
                return false;
            }
        }

        async function payWithMercadoPago() {
            // Validar formulario de envío (seguimos pidiéndolo para registrar datos)
            const address = document.getElementById('ship-address').value;
            const city = document.getElementById('ship-city').value;
            const phone = document.getElementById('ship-phone').value;

            if (!address || !city || !phone) {
                mostrarNotificacion('Por favor completa todos los campos de envío', 'warning');
                return;
            }
            
            const ready = await ensureCheckoutCart();
            if (!ready) {
                mostrarNotificacion('Tu carrito está vacío. Agrega productos desde el catálogo e inténtalo nuevamente.', 'warning');
                return;
            }

            const btn = document.getElementById('checkout-cta');
            try {
                if (btn){ btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Redirigiendo...'; }
                const items = cartItems.map(it => ({
                    title: it.name,
                    quantity: it.quantity,
                    unit_price: it.price,
                    picture_url: it.image,
                    currency_id: 'CLP'
                }));

                const pref = await apiCall('/api/pagos/crear-preferencia', 'POST', { items, metadata: { address, city, phone } });
                if (pref && pref.init_point) {
                    window.location.href = pref.init_point;
                } else {
                    mostrarNotificacion('No se pudo iniciar el pago', 'error');
                }
            } catch (e) {
                console.error(e);
                const msg = (e && e.message) ? e.message : 'Error creando preferencia de pago';
                mostrarNotificacion(msg, 'error');
            } finally {
                if (btn){ btn.disabled = false; btn.textContent = 'Pagar con MercadoPago'; }
            }
        }

        async function payWithCard(){
            const address = document.getElementById('ship-address').value;
            const city = document.getElementById('ship-city').value;
            const phone = document.getElementById('ship-phone').value;
            const number = document.getElementById('card-number')?.value;
            const expiry = document.getElementById('card-expiry')?.value;
            const cvv = document.getElementById('card-cvv')?.value;
            if (!address || !city || !phone || !number || !expiry || !cvv){
                mostrarNotificacion('Completa los datos de envío y tarjeta', 'warning');
                return;
            }

            const ready = await ensureCheckoutCart();
            if (!ready) {
                mostrarNotificacion('Tu carrito está vacío. Agrega productos nuevamente antes de pagar.', 'warning');
                return;
            }
            const btn = document.getElementById('checkout-cta');
            const name = localStorage.getItem('user_nombre') || 'Cliente';
            const email = localStorage.getItem('user_email') || '';
            try{
                if (btn){ btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando pago...'; }
                // Simulación: pago aprobado
                await new Promise(r=>setTimeout(r, 1200));
                // Crear pedido para registrar la compra
                const pedido = await apiCall('/api/pedidos', 'POST', { name, email, address, city });
                if (pedido && pedido.id){
                    mostrarNotificacion('Pago aprobado. Pedido creado con éxito.', 'success');
                    cartItems = [];
                    try { saveCart([]); } catch(_){ }
                    Cart.updateCartBadge();
                    setTimeout(()=>{ window.location.href = '/app/cuenta/?pago=ok'; }, 800);
                } else {
                    mostrarNotificacion('Pago aprobado pero no se pudo crear el pedido', 'warning');
                }
            } catch(e){
                mostrarNotificacion('No se pudo procesar el pago', 'error');
            } finally {
                if (btn){ btn.disabled = false; btn.textContent = 'Pagar ahora'; }
            }
        }

        async function placeCashOrder(){
            const address = document.getElementById('ship-address').value;
            const city = document.getElementById('ship-city').value;
            const phone = document.getElementById('ship-phone').value;
            if (!address || !city || !phone){
                mostrarNotificacion('Por favor completa todos los campos de envío', 'warning');
                return;
            }

            const ready = await ensureCheckoutCart();
            if (!ready) {
                mostrarNotificacion('Tu carrito está vacío. Agrega productos antes de confirmar.', 'warning');
                return;
            }
            const name = localStorage.getItem('user_nombre') || 'Cliente';
            const email = localStorage.getItem('user_email') || '';
            const btn = document.getElementById('checkout-cta');
            try{
                if (btn){ btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando pedido...'; }
                const pedido = await apiCall('/api/pedidos', 'POST', { name, email, address, city });
                if (pedido && pedido.id){
                    mostrarNotificacion('Pedido creado con éxito. Pagarás al recibir.', 'success');
                    // Limpiar carrito local por si acaso
                    cartItems = [];
                    try { saveCart([]); } catch(_){ }
                    Cart.updateCartBadge();
                    setTimeout(()=>{ window.location.href = '/app/cuenta/'; }, 1000);
                } else {
                    mostrarNotificacion('No se pudo crear el pedido', 'error');
                }
            } catch(e){
                console.error(e);
                mostrarNotificacion('Error creando pedido', 'error');
            } finally {
                if (btn){ btn.disabled = false; btn.textContent = 'Confirmar pedido'; }
            }
        }
    </script>
</body>
</html>
