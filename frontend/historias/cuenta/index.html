<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Natural Power</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../../../static/css/style.css">
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand text-success" href="/app/inicio/"><i class="bi bi-tree-fill me-2"></i><strong>Natural Power</strong></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/app/inicio/">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/app/catalogo/">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="/app/crea-tu-jugo/">Crea tu Jugo</a></li>
                </ul>
                
                <form class="d-flex mx-lg-2" onsubmit="event.preventDefault(); searchProducts();">
                    <input id="search-input" class="form-control me-2" type="search" placeholder="Buscar jugos..." onkeyup="searchProducts()">
                </form>

                <div class="d-flex align-items-center">
                    <div id="guest-actions" class="d-flex">
                        <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Registrarse</button>
                    </div>
                    <div id="user-actions" class="d-flex align-items-center" style="display: none;">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-person-circle me-1"></i> <span id="user-dropdown-name"></span></a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/app/cuenta/">Mi Cuenta</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" onclick="logout()">Cerrar Sesión</button></li>
                            </ul>
                        </div>
                    </div>
                    <a href="/app/carrito/" class="btn btn-link text-dark ms-2 position-relative fs-5"><i class="bi bi-cart"></i><span id="cart-counter" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" style="font-size: 0.6rem;"></span></a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modales de Login y Registro -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Iniciar Sesión</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <form onsubmit="handleLogin(event)">
                    <div class="modal-body">
                        <div class="mb-3"><label class="form-label">Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Contraseña</label><input type="password" name="password" class="form-control" required></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Ingresar</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Registrarse</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <form onsubmit="handleRegister(event)">
                    <div class="modal-body">
                        <div class="mb-3"><label class="form-label">Nombre</label><input type="text" name="name" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Contraseña</label><input type="password" name="password" class="form-control" required></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Registrarse</button></div>
                </form>
            </div>
        </div>
    </div>

    <main class="container my-5 pt-5">
        <h2 class="section-title mb-4">Mi Cuenta</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="bi bi-person-circle me-2"></i>Mi Perfil</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre</label>
                            <p id="profile-name" class="form-control-plaintext">Cargando...</p>
                            <!-- Filtros y paginación -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Desde</label>
                                    <input type="date" id="orders-from" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Hasta</label>
                                    <input type="date" id="orders-to" class="form-control">
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button id="orders-apply" class="btn btn-outline-primary w-100"><i class="bi bi-funnel me-1"></i>Aplicar filtros</button>
                                </div>
                            </div>
                            <div id="orders-pagination" class="d-flex justify-content-between align-items-center mb-2" style="display:none;">
                                <button id="orders-prev" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-left"></i></button>
                                <div>
                                    <span id="orders-page-info" class="text-muted"></span>
                                </div>
                                <button id="orders-next" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <p id="profile-email" class="form-control-plaintext">Cargando...</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Dirección</label>
                            <p id="profile-address" class="form-control-plaintext">Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-info text-white"><h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Sesiones Activas</h5></div>
                    <div class="card-body" id="sessions-container">
                        <p class="text-muted">Cargando sesiones...</p>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header bg-warning text-dark"><h5 class="mb-0"><i class="bi bi-star-fill me-2"></i>Mis Puntos</h5></div>
                    <div class="card-body" id="points-container">
                        <p class="text-muted">Cargando puntos...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <ul class="nav nav-tabs mb-3" id="accountTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                            <i class="bi bi-bag-check me-1"></i>Mis Pedidos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">
                            <i class="bi bi-list-ul me-1"></i>Actividad Reciente
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="accountTabsContent">
                    <div class="tab-pane fade show active" id="orders" role="tabpanel">
                        <div class="card">
                            <div class="card-body" id="order-history">
                                <p class="text-muted">Cargando pedidos...</p>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <div class="card">
                            <div class="card-body" id="activity-history">
                                <p class="text-muted">Cargando actividad...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../../static/js/config.js"></script>
    <script src="../../../static/js/main.js"></script>
    <script src="../../../static/js/auth.js"></script>
    
    <script>
        // Proteger página
        if (!requireAuth()) {
            document.body.innerHTML = '<div class="container mt-5 pt-5 text-center"><h3>Redirigiendo...</h3><p>Debes iniciar sesión para ver tu cuenta</p></div>';
        } else {
            loadAccountPage();
        }

        async function loadAccountPage() {
            await Promise.all([
                loadUserProfile(),
                loadSessions(),
                loadActivity(),
                loadOrders(),
                loadPoints()
            ]);
        }

        async function loadUserProfile() {
            try {
                const userData = await obtenerDatosUsuario();
                if (userData) {
                    document.getElementById('profile-name').textContent = userData.nombre || 'No especificado';
                    document.getElementById('profile-email').textContent = userData.email || 'No especificado';
                    document.getElementById('profile-address').textContent = userData.direccion || 'No especificado';
                }
            } catch (error) {
                console.error('Error cargando perfil:', error);
                document.getElementById('profile-name').textContent = 'Error al cargar';
            }
        }

        async function loadSessions() {
            try {
                const sessions = await obtenerSesiones();
                const container = document.getElementById('sessions-container');
                
                if (!sessions || sessions.length === 0) {
                    container.innerHTML = '<p class="text-muted small">No hay sesiones activas</p>';
                    return;
                }

                container.innerHTML = '<div class="list-group list-group-flush">' + 
                    sessions.map(session => {
                        const loginDate = new Date(session.login_time);
                        const lastActivity = new Date(session.last_activity);
                        return `
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-laptop text-primary me-2"></i>
                                        <small>${session.ip_address || 'IP desconocida'}</small>
                                    </div>
                                    <span class="badge bg-success">Activa</span>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    Login: ${loginDate.toLocaleDateString()} ${loginDate.toLocaleTimeString()}
                                </small>
                                <small class="text-muted d-block">
                                    Última actividad: ${lastActivity.toLocaleDateString()} ${lastActivity.toLocaleTimeString()}
                                </small>
                            </div>
                        `;
                    }).join('') + 
                    '</div>';
            } catch (error) {
                console.error('Error cargando sesiones:', error);
                document.getElementById('sessions-container').innerHTML = '<p class="text-danger small">Error al cargar sesiones</p>';
            }
        }

        async function loadActivity() {
            try {
                const activities = await obtenerActividades();
                const container = document.getElementById('activity-history');
                
                if (!activities || activities.length === 0) {
                    container.innerHTML = '<p class="text-muted">No hay actividad registrada</p>';
                    return;
                }

                container.innerHTML = '<div class="list-group">' + 
                    activities.slice(0, 20).map(activity => {
                        const activityDate = new Date(activity.timestamp);
                        let icon = 'bi-circle';
                        let color = 'secondary';
                        
                        if (activity.action.includes('login')) {
                            icon = 'bi-box-arrow-in-right';
                            color = 'success';
                        } else if (activity.action.includes('logout')) {
                            icon = 'bi-box-arrow-right';
                            color = 'warning';
                        } else if (activity.action.includes('carrito') || activity.action.includes('cart')) {
                            icon = 'bi-cart';
                            color = 'info';
                        } else if (activity.action.includes('pedido') || activity.action.includes('order')) {
                            icon = 'bi-bag-check';
                            color = 'primary';
                        }
                        
                        return `
                            <div class="list-group-item">
                                <div class="d-flex align-items-start">
                                    <i class="bi ${icon} text-${color} me-3 fs-5"></i>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <strong>${activity.action}</strong>
                                            <small class="text-muted">${activityDate.toLocaleDateString()} ${activityDate.toLocaleTimeString()}</small>
                                        </div>
                                        ${activity.details ? `<small class="text-muted">${activity.details}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') + 
                    '</div>';
            } catch (error) {
                console.error('Error cargando actividad:', error);
                document.getElementById('activity-history').innerHTML = '<p class="text-danger">Error al cargar actividad</p>';
            }
        }

        async function loadPoints() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) { document.getElementById('points-container').innerHTML = '<p class="text-muted">No autenticado</p>'; return; }
                const response = await fetch(`${API_BASE_URL}/api/usuarios/me/puntos`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                const total = Number((data.body && data.body.puntos) || 0);
                document.getElementById('points-container').innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-trophy text-warning fs-1 me-3"></i>
                        <div>
                            <div class="fs-3 fw-bold">${total}</div>
                            <div class="text-muted">puntos acumulados</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error cargando puntos', e);
                document.getElementById('points-container').innerHTML = '<p class="text-danger">Error al cargar puntos</p>';
            }
        }

        // Estado de pedidos y paginación en memoria
        let ALL_ORDERS = [];
        let FILTERED_ORDERS = [];
        let ORDERS_PAGE = 1;
        const PAGE_SIZE = 10;

        function applyOrderFilters() {
            const fromVal = document.getElementById('orders-from').value;
            const toVal = document.getElementById('orders-to').value;
            const fromDate = fromVal ? new Date(fromVal + 'T00:00:00') : null;
            const toDate = toVal ? new Date(toVal + 'T23:59:59') : null;

            FILTERED_ORDERS = ALL_ORDERS.filter(o => {
                const d = new Date(o.created_at);
                const afterFrom = fromDate ? d >= fromDate : true;
                const beforeTo = toDate ? d <= toDate : true;
                return afterFrom && beforeTo;
            });
            ORDERS_PAGE = 1;
            renderOrdersPage();
        }

        function renderOrdersPage() {
            const container = document.getElementById('order-history');
            if (!FILTERED_ORDERS || FILTERED_ORDERS.length === 0) {
                document.getElementById('orders-pagination').style.display = 'none';
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-bag-x fs-1 text-muted"></i>
                        <p class="text-muted mt-3">Aún no has realizado ningún pedido</p>
                        <a href="/app/catalogo/" class="btn btn-primary mt-2">Explorar Catálogo</a>
                    </div>
                `;
                return;
            }

            const totalPages = Math.ceil(FILTERED_ORDERS.length / PAGE_SIZE) || 1;
            ORDERS_PAGE = Math.min(Math.max(1, ORDERS_PAGE), totalPages);
            const start = (ORDERS_PAGE - 1) * PAGE_SIZE;
            const pageItems = FILTERED_ORDERS.slice(start, start + PAGE_SIZE);

            document.getElementById('orders-pagination').style.display = 'flex';
            document.getElementById('orders-page-info').textContent = `Página ${ORDERS_PAGE} de ${totalPages} · ${FILTERED_ORDERS.length} pedido(s)`;

            container.innerHTML = pageItems.map(order => {
                const orderDate = new Date(order.created_at);
                return `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Pedido #${order.id}</strong><br>
                                <small class="text-muted">${orderDate.toLocaleDateString()} ${orderDate.toLocaleTimeString()}</small>
                            </div>
                            <h5 class="mb-0 text-success">$${Number(order.total).toLocaleString()}</h5>
                        </div>
                        <div class="card-body">
                            <h6>Productos:</h6>
                            <ul class="list-unstyled">
                                ${(order.items || []).map(item => `
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        ${item.name} x${item.quantity} - $${Number(item.price * item.quantity).toLocaleString()}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('orders-prev').disabled = ORDERS_PAGE <= 1;
            document.getElementById('orders-next').disabled = ORDERS_PAGE >= totalPages;
        }

        async function loadOrders() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/api/pedidos`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                ALL_ORDERS = (data.body || []).slice();
                // Ordenar por fecha descendente
                ALL_ORDERS.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                FILTERED_ORDERS = ALL_ORDERS.slice();
                ORDERS_PAGE = 1;
                renderOrdersPage();

                // Listeners filtros y paginación
                const btnApply = document.getElementById('orders-apply');
                if (btnApply && !btnApply.dataset.bound) {
                    btnApply.addEventListener('click', applyOrderFilters);
                    btnApply.dataset.bound = '1';
                }
                const btnPrev = document.getElementById('orders-prev');
                const btnNext = document.getElementById('orders-next');
                if (btnPrev && !btnPrev.dataset.bound) {
                    btnPrev.addEventListener('click', () => { ORDERS_PAGE = Math.max(1, ORDERS_PAGE - 1); renderOrdersPage(); });
                    btnPrev.dataset.bound = '1';
                }
                if (btnNext && !btnNext.dataset.bound) {
                    btnNext.addEventListener('click', () => { ORDERS_PAGE = ORDERS_PAGE + 1; renderOrdersPage(); });
                    btnNext.dataset.bound = '1';
                }
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                document.getElementById('order-history').innerHTML = '<p class="text-danger">Error al cargar pedidos</p>';
            }
        }
    </script>

    <a href="https://wa.me/56978830473?text=Hola%20Natural%20Power,%20tengo%20una%20consulta" class="whatsapp-float" target="_blank">
        <i class="bi bi-whatsapp"></i>
    </a>
</body>
</html>
